/*! Leaflet-WFST 1.0.0 2015-06-15 */
(function(b,a,c){L.XmlUtil={namespaces:{xlink:"http://www.w3.org/1999/xlink",xmlns:"http://www.w3.org/2000/xmlns/",xsd:"http://www.w3.org/2001/XMLSchema",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",gml:"http://www.opengis.net/gml",ogc:"http://www.opengis.net/ogc",ows:"http://www.opengis.net/ows"},xmldoc:(new DOMParser()).parseFromString("<root />","text/xml"),setAttributes:function(g,d){for(var e in d){if(d[e]!=null&&d[e].toString){var h=d[e].toString();var f=this.namespaces[e.substring(0,e.indexOf(":"))]||null;g.setAttributeNS(f,e,h)}}},evaluate:function(e,g){var i=new DOMParser();var h=i.parseFromString(g,"text/xml");var f=new XPathEvaluator();var d=f.createNSResolver(h.documentElement);return f.evaluate(e,h,d,XPathResult.ANY_TYPE,null)},createElementNS:function(f,d,e){e=e||{};var h=e.uri;if(!h){h=this.namespaces[f.substring(0,f.indexOf(":"))]}if(!h){h=this.namespaces[e.prefix]}var g=h?this.xmldoc.createElementNS(h,f):this.xmldoc.createElement(f);if(d){this.setAttributes(g,d)}if(e.value!=null){g.appendChild(this.xmldoc.createTextNode(e.value))}return g},createTextNode:function(d){return this.xmldoc.createTextNode(d)},serializeXmlDocumentString:function(e){var f=a.implementation.createDocument("","",null);f.appendChild(e);var d=new XMLSerializer();return d.serializeToString(f)},serializeXmlToString:function(e){var d=new XMLSerializer();return d.serializeToString(e)},parseXml:function(d){if(typeof b.DOMParser!=="undefined"){return(new b.DOMParser()).parseFromString(d,"text/xml")}else{if(typeof b.ActiveXObject!=="undefined"&&new b.ActiveXObject("Microsoft.XMLDOM")){var e=new b.ActiveXObject("Microsoft.XMLDOM");e.async="false";e.loadXML(d);return e}else{throw new Error("No XML parser found")}}}};L.Util.request=function(e){e=L.extend({async:true,method:"POST",data:"",params:{},headers:{},url:b.location.href,success:function(h){console.log(h)},error:function(h){console.log("Ajax request fail");console.log(h)},complete:function(){}},e);var f=new XMLHttpRequest();f.onreadystatechange=function(){if(f.readyState===4){if(f.status===200){e.success(f.responseText)}else{e.error(f.responseText)}e.complete()}};var d=e.url+L.Util.getParamString(e.params,e.url);f.open(e.method,d,e.async);for(var g in e.headers){f.setRequestHeader(g,e.headers[g])}f.send(e.data)};L.Filter=L.Class.extend({initialize:function(){this.filter=L.XmlUtil.createElementNS("ogc:Filter")},toGml:function(){return this.filter},append:function(){return this}});L.Filter.GmlObjectID=L.Filter.extend({append:function(d){this.filter.appendChild(L.XmlUtil.createElementNS("ogc:GmlObjectId",{"gml:id":d}));return this}});L.Format={};L.Format.Scheme=L.Class.extend({initialize:function(d){this.geometryField=d},parse:function(h){var l=new L.GML.FeatureType();var k=h.getElementsByTagNameNS(L.XmlUtil.namespaces.xsd,"complexType")[0];var n=k.getElementsByTagNameNS(L.XmlUtil.namespaces.xsd,"sequence")[0];for(var j=0;j<n.childNodes.length;j++){var f=n.childNodes[j];if(f.nodeType!==a.ELEMENT_NODE){continue}var d=f.attributes.name;if(!d){continue}var m=f.attributes.name.value;if(m===this.geometryField){continue}var g=f.attributes.type;if(!g){var e=f.getElementsByTagNameNS(L.XmlUtil.namespaces.xsd,"restriction");g=e.attributes.base}if(!g){continue}var o=g.value.split(":").pop();l.appendField(m,o)}return l}});L.Format.Base=L.Class.extend({defaultOptions:{crs:L.CRS.EPSG3857,coordsToLatLng:function(d){return new L.LatLng(d[1],d[0],d[2])},latLngToCoords:function(e){var d=[e.lng,e.lat];if(e.alt!==c){d.push(e.alt)}return d},geometryField:"Shape"},initialize:function(e){L.setOptions(this,L.extend({},this.defaultOptions,e));if(e.crs){var d=e.crs;this.options.coordsToLatLng=function(g){var f=L.point(g[0],g[1]);var h=d.projection.unproject(f);if(g[2]){h.alt=g[2]}return h};this.options.latLngToCoords=function(g){var f=L.latLng(g);return d.projection.project(f)}}},setFeatureDescription:function(e){this.namespaceUri=e.attributes.targetNamespace.value;var d=new L.Format.Scheme(this.options.geometryField);this.featureType=d.parse(e)}});L.Format.GeoJSON=L.Format.Base.extend({initialize:function(d){L.Format.Base.prototype.initialize.call(this,d);this.outputFormat="application/json"},responseToLayers:function(g){var f=[];var d=JSON.parse(g);for(var e=0;e<d.features.length;e++){f.push(this.processFeature(d.features[e]))}return f},processFeature:function(e){var d=this.generateLayer(e);d.feature=e;return d},generateLayer:function(d){return L.GeoJSON.geometryToLayer(d,this.options.pointToLayer||null,this.options.coordsToLatLng||null,null)}});L.GML=L.GML||{};L.GML.ParserContainerMixin={parsers:{},initializeParserContainer:function(){this.parsers={}},appendParser:function(d){this.parsers[d.elementTag]=d},parseElement:function(e,d){var f=this.parsers[e.tagName];if(!f){throw ("unknown child element "+e.tagName)}return f.parse(e,d)}};L.GML.Element=L.Class.extend({elementTag:"",parse:function(){throw ("not implemented parse function in parser for "+this.elementTag)}});L.GML.Geometry=L.GML.Element.extend({statics:{DIM:2},dimensions:function(d){if(d.attributes.srsDimension){return parseInt(d.attributes.srsDimension.value)}return L.GML.Geometry.DIM}});L.GML.Coordinates=L.GML.Element.extend({defaultSeparator:{ds:".",cs:",",ts:" "},initialize:function(){this.elementTag="gml:coordinates"},parse:function(g){var l=this.defaultSeparator.ds;if(g.attributes.decimal){l=g.attributes.decimal.value}var h=this.defaultSeparator.cs;if(g.attributes.cs){h=g.attributes.cs.value}var j=this.defaultSeparator.ts;if(g.attributes.ts){j=g.attributes.ts.value}var d=[];var k=g.textContent.split(j);var f=function(i){if(l!=="."){i=i.replace(l,".")}return parseFloat(i)};for(var e=0;e<k.length;e++){d.push(k[e].split(h).map(f))}if(d.length===1){return d[0]}return d}});L.GML.Pos=L.GML.Element.extend({initialize:function(){this.elementTag="gml:pos"},parse:function(d){return d.textContent.split(" ").map(function(e){return parseFloat(e)})}});L.GML.PosList=L.GML.Element.extend({initialize:function(){this.elementTag="gml:posList"},parse:function(h,f){var d=[];var l=f.dimensions;var k=h.textContent.split(" ");for(var g=0;g<k.length;g+=l){var m=[];for(var e=g;e<g+l;e++){m.push(parseFloat(k[e]))}d.push(m)}return d}});L.GML.PointNode=L.GML.Geometry.extend({includes:L.GML.ParserContainerMixin,initialize:function(){this.elementTag="gml:Point";this.initializeParserContainer();this.appendParser(new L.GML.Pos());this.appendParser(new L.GML.Coordinates())},parse:function(d){return this.parseElement(d.firstChild,{dimensions:this.dimensions(d)})}});L.GML.PointSequence=L.GML.Geometry.extend({includes:L.GML.ParserContainerMixin,initialize:function(){this.initializeParserContainer();this.appendParser(new L.GML.Pos());this.appendParser(new L.GML.PosList());this.appendParser(new L.GML.Coordinates());this.appendParser(new L.GML.PointNode())},parse:function(f){var j=f.firstChild;var h=[];var e=j.tagName;if(e==="gml:pos"||e==="gml:Point"){var k=this.parsers[e];var g=f.getElementsByTagNameNS(L.XmlUtil.namespaces.gml,e.split(":").pop());for(var d=0;d<g.length;d++){h.push(k.parse(g[d]))}}else{h=this.parseElement(j,{dimensions:this.dimensions(f)})}return h}});L.GML.LinearRing=L.GML.PointSequence.extend({initialize:function(){L.GML.PointSequence.prototype.initialize.call(this);this.elementTag="gml:LinearRing"},parse:function(d){var e=L.GML.PointSequence.prototype.parse.call(this,d);e.pop();return e}});L.GML.CoordsToLatLngMixin={transform:function(g,d){if(Array.isArray(g[0])){var f=[];for(var e=0;e<g.length;e++){f.push(this.transform(g[e],d))}return f}return d.coordsToLatLng(g)}};L.GML.Point=L.GML.PointNode.extend({includes:L.GML.CoordsToLatLngMixin,parse:function(f,d){var g=L.GML.PointNode.prototype.parse.call(this,f);var e=new L.Marker();e.setLatLng(this.transform(g,d));return e}});L.GML.LineString=L.GML.PointSequence.extend({includes:L.GML.CoordsToLatLngMixin,initialize:function(){this.elementTag="gml:LineString";L.GML.PointSequence.prototype.initialize.call(this)},parse:function(f,d){var e=new L.Polyline([]);var h=L.GML.PointSequence.prototype.parse.call(this,f);var g=this.transform(h,d);return e.setLatLngs(g)}});L.GML.Polygon=L.GML.Geometry.extend({includes:L.GML.CoordsToLatLngMixin,initialize:function(){this.elementTag="gml:Polygon";this.linearRingParser=new L.GML.LinearRing()},getCoordinates:function(e){var f=[];for(var d=0;d<e.childNodes.length;d++){var g=e.childNodes[d];if(g.nodeType===a.ELEMENT_NODE){f.push(this.linearRingParser.parse(g.firstChild))}}return f},parse:function(f,d){var e=new L.Polygon([]);var g=this.getCoordinates(f);e.setLatLngs(this.transform(g,d));return e}});L.GML.MultiGeometry=L.GML.Geometry.extend({includes:L.GML.ParserContainerMixin,initialize:function(){this.initializeParserContainer()},parse:function(h,f){var l=[];for(var g=0;g<h.childNodes.length;g++){var d=h.childNodes[g];if(d.nodeType!==a.ELEMENT_NODE){continue}for(var e=0;e<d.childNodes.length;e++){var k=d.childNodes[e];if(k.nodeType!==a.ELEMENT_NODE){continue}l.push(this.parseElement(k,f))}}return l}});L.GML.AbstractMultiPolyline=L.GML.MultiGeometry.extend({parse:function(g,d){var h=L.GML.MultiGeometry.prototype.parse.call(this,g,d);var f=new L.MultiPolyline([]);for(var e=0;e<h.length;e++){f.addLayer(h[e])}return f}});L.GML.AbstractMultiPolygon=L.GML.MultiGeometry.extend({parse:function(g,d){var h=L.GML.MultiGeometry.prototype.parse.call(this,g,d);var f=new L.MultiPolygon([]);for(var e=0;e<h.length;e++){f.addLayer(h[e])}return f}});L.GML.MultiLineString=L.GML.AbstractMultiPolyline.extend({initialize:function(){L.GML.AbstractMultiPolyline.prototype.initialize.call(this);this.appendParser(new L.GML.LineString());this.elementTag="gml:MultiLineString"}});L.GML.MultiCurve=L.GML.AbstractMultiPolyline.extend({initialize:function(){L.GML.AbstractMultiPolyline.prototype.initialize.call(this);this.elementTag="gml:MultiCurve";this.appendParser(new L.GML.LineString())}});L.GML.MultiPolygon=L.GML.AbstractMultiPolygon.extend({initialize:function(){L.GML.AbstractMultiPolygon.prototype.initialize.call(this);this.elementTag="gml:MultiPolygon";this.appendParser(new L.GML.Polygon())}});L.GML.MultiSurface=L.GML.AbstractMultiPolygon.extend({initialize:function(){L.GML.AbstractMultiPolygon.prototype.initialize.call(this);this.elementTag="gml:MultiSurface";this.appendParser(new L.GML.Polygon())}});L.GML.MultiPoint=L.GML.MultiGeometry.extend({initialize:function(){L.GML.MultiGeometry.prototype.initialize.call(this);this.elementTag="gml:MultiPoint";this.appendParser(new L.GML.Point())},parse:function(e,d){var f=L.GML.MultiGeometry.prototype.parse.call(this,e,d);return new L.FeatureGroup(f)}});L.GML.FeatureType=L.Class.extend({primitives:[{types:["byte","decimal","int","integer","long","short"],parse:function(d){return Number(d)}},{types:["string"],parse:function(d){return d}},{types:["boolean"],parse:function(d){return d!=="false"}},{types:["date","time","datetime"],parse:function(d){return new Date(d)}}],initialize:function(){this.fields={}},appendField:function(d,e){var f=this;this.primitives.forEach(function(g){if(g.types.indexOf(e)!==-1){f.fields[d]=g.parse}})},parse:function(h){var g={};for(var f=0;f<h.childNodes.length;f++){var j=h.childNodes[f];if(j.nodeType!==a.ELEMENT_NODE){continue}var e=j.tagName.split(":").pop();var d=this.fields[e];if(!d){continue}g[e]=d(j.textContent)}return{properties:g,id:h.attributes["gml:id"].value}}});L.Format.GML=L.Format.Base.extend({includes:L.GML.ParserContainerMixin,initialize:function(d){L.Format.Base.prototype.initialize.call(this,d);this.outputFormat="text/xml; subtype=gml/3.1.1";this.initializeParserContainer();this.appendParser(new L.GML.Point());this.appendParser(new L.GML.LineString());this.appendParser(new L.GML.Polygon());this.appendParser(new L.GML.MultiLineString());this.appendParser(new L.GML.MultiPolygon());this.appendParser(new L.GML.MultiCurve());this.appendParser(new L.GML.MultiSurface());this.appendParser(new L.GML.MultiPoint())},responseToLayers:function(d){var l=[];var o=L.XmlUtil.parseXml(d);var e=o.documentElement;var n=e.getElementsByTagNameNS(L.XmlUtil.namespaces.gml,"featureMember");for(var m=0;m<n.length;m++){var p=n[m].firstChild;l.push(this.processFeature(p))}var h=e.getElementsByTagNameNS(L.XmlUtil.namespaces.gml,"featureMembers");if(h.length>0){var f=h[0].childNodes;for(var k=0;k<f.length;k++){var g=f[k];if(g.nodeType===a.ELEMENT_NODE){l.push(this.processFeature(g))}}}return l},processFeature:function(e){var d=this.generateLayer(e);d.feature=this.featureType.parse(e);return d},generateLayer:function(e){var d=e.getElementsByTagNameNS(this.namespaceUri,this.options.geometryField)[0];return this.parseElement(d.firstChild,this.options)}});L.Util.project=function(f,e){if(L.Util.isArray(e)){var d=[];e.forEach(function(g){d.push(f.projection.project(g))});return d}else{return f.projection.project(e)}};L.GMLUtil={posNode:function(d){return L.XmlUtil.createElementNS("gml:pos",{srsDimension:2},{value:d.x+" "+d.y})},posListNode:function(d,f){var e=[];d.forEach(function(i){e.push(i.x+" "+i.y)});if(f&&d.length>0){var h=d[0];e.push(h.x+" "+h.y)}var g=e.join(" ");return L.XmlUtil.createElementNS("gml:posList",{},{value:g})}};L.Marker.include({toGml:function(d){var e=L.XmlUtil.createElementNS("gml:Point",{srsName:d.code});e.appendChild(L.GMLUtil.posNode(L.Util.project(d,this.getLatLng())));return e}});L.MultiPolygon.include({toGml:function(d){var e=L.XmlUtil.createElementNS("gml:MultiPolygon",{srsName:d.code,srsDimension:2});var f=e.appendChild(L.XmlUtil.createElementNS("gml:polygonMembers"));this.eachLayer(function(g){f.appendChild(g.toGml(d))});return e}});L.MultiPolyline.include({toGml:function(d){var e=L.XmlUtil.createElementNS("gml:MultiLineString",{srsName:d.code,srsDimension:2});var f=e.appendChild(L.XmlUtil.createElementNS("gml:lineStringMembers"));this.eachLayer(function(g){f.appendChild(g.toGml(d))});return e}});L.Polygon.include({toGml:function(d){var e=L.XmlUtil.createElementNS("gml:Polygon",{srsName:d.code,srsDimension:2});e.appendChild(L.XmlUtil.createElementNS("gml:exterior")).appendChild(L.XmlUtil.createElementNS("gml:LinearRing",{srsDimension:2})).appendChild(L.GMLUtil.posListNode(L.Util.project(d,this.getLatLngs()),true));if(this._holes&&this._holes.length){for(var f in this._holes){e.appendChild(L.XmlUtil.createElementNS("gml:interior")).appendChild(L.XmlUtil.createElementNS("gml:LinearRing",{srsDimension:2})).appendChild(L.GMLUtil.posListNode(L.Util.project(d,this._holes[f]),true))}}return e}});L.Polyline.include({toGml:function(d){var e=L.XmlUtil.createElementNS("gml:LineString",{srsName:d.code,srsDimension:2});e.appendChild(L.GMLUtil.posListNode(L.Util.project(d,this.getLatLngs()),false));return e}});L.WFS=L.FeatureGroup.extend({options:{crs:L.CRS.EPSG3857,showExisting:true,geometryField:"Shape",url:"",version:"1.1.0",typeNS:"",typeName:"",typeNSName:"",style:{color:"black",weight:1},namespaceUri:""},state:{},initialize:function(e,d){L.setOptions(this,e);this.state={exist:"exist"};this._layers={};this.readFormat=d||new L.Format.GML({crs:this.options.crs,geometryField:this.options.geometryField});this.options.typeNSName=this.namespaceName(this.options.typeName);this.options.srsName=this.options.crs.code;var f=this;this.describeFeatureType(function(){if(f.options.showExisting){f.loadFeatures()}})},namespaceName:function(d){return this.options.typeNS+":"+d},describeFeatureType:function(f){var d=L.XmlUtil.createElementNS("wfs:DescribeFeatureType",{service:"WFS",version:this.options.version});d.appendChild(L.XmlUtil.createElementNS("TypeName",{},{value:this.options.typeNSName}));var e=this;L.Util.request({url:this.options.url,data:L.XmlUtil.serializeXmlDocumentString(d),success:function(h){var g=L.XmlUtil.parseXml(h);var i=g.documentElement;e.readFormat.setFeatureDescription(i);e.options.namespaceUri=i.attributes.targetNamespace.value;if(typeof(f)==="function"){f()}}})},getFeature:function(d){var e=L.XmlUtil.createElementNS("wfs:GetFeature",{service:"WFS",version:this.options.version,outputFormat:this.readFormat.outputFormat});var f=e.appendChild(L.XmlUtil.createElementNS("wfs:Query",{typeName:this.options.typeNSName,srsName:this.options.srsName}));if(d&&d.toGml){f.appendChild(d.toGml())}return e},loadFeatures:function(d){var e=this;L.Util.request({url:this.options.url,data:L.XmlUtil.serializeXmlDocumentString(e.getFeature(d)),success:function(f){var g=e.readFormat.responseToLayers(f,{coordsToLatLng:e.options.coordsToLatLng,pointToLayer:e.options.pointToLayer});g.forEach(function(h){h.state=e.state.exist;e.addLayer(h)});e.setStyle(e.options.style);e.fire("load");return e}})}});L.wfs=function(e,d){return new L.WFS(e,d)};L.WFST=L.WFS.extend({initialize:function(e,d){L.WFS.prototype.initialize.call(this,e,d);this.state=L.extend(this.state,{insert:"insert",update:"update",remove:"remove"});this.changes={}},addLayer:function(d){L.FeatureGroup.prototype.addLayer.call(this,d);if(!d.feature){d.feature={properties:{}}}if(!d.state){d.state=this.state.insert;var e=this.getLayerId(d);this.changes[e]=d}return this},removeLayer:function(d){L.FeatureGroup.prototype.removeLayer.call(this,d);var f=this.getLayerId(d);if(f in this.changes){var e=this.changes[f];if(e.state===this.state.insert){delete this.changes[f]}else{e.state=this.state.remove}}else{d.state=this.state.remove;this.changes[f]=d}},editLayer:function(d){if(d.state!==this.state.insert){d.state=this.state.update}var e=this.getLayerId(d);this.changes[e]=d;return this},save:function(){var h=L.XmlUtil.createElementNS("wfs:Transaction",{service:"WFS",version:this.options.version});var e=[];for(var i in this.changes){var d=this.changes[i];var g=this[d.state](d);h.appendChild(g);if(d.state===this.state.insert){e.push(d)}}var f=this;L.Util.request({url:this.options.url,data:L.XmlUtil.serializeXmlDocumentString(h),success:function(l){var k=L.XmlUtil.evaluate("//wfs:InsertResults/wfs:Feature/ogc:FeatureId/@fid",l);var j=new L.Filter.GmlObjectID();var m=k.iterateNext();while(m){j.append(m.value);m=k.iterateNext()}e.forEach(function(n){L.FeatureGroup.prototype.removeLayer.call(f,n)});f.once("load",function(){f.fire("save:success");f.changes={}});f.loadFeatures(j)}});return this}});L.wfst=function(e,d){return new L.WFST(e,d)};L.WFST.include({gmlFeature:function(f){var g=L.XmlUtil.createElementNS(this.options.typeNSName,{},{uri:this.options.namespaceUri});var e=f.feature;for(var d in e.properties){g.appendChild(this.gmlProperty(d,e.properties[d]))}g.appendChild(this.gmlProperty(this.options.geometryField,f.toGml(this.options.crs)));return g},gmlProperty:function(d,f){var e=L.XmlUtil.createElementNS(this.namespaceName(d));if(f instanceof Element){e.appendChild(f)}else{e.appendChild(L.XmlUtil.createTextNode(f||""))}return e},wfsProperty:function(e,g){var f=L.XmlUtil.createElementNS("wfs:Property");f.appendChild(L.XmlUtil.createElementNS("wfs:Name",{},{value:e}));var d=L.XmlUtil.createElementNS("wfs:Value");if(g instanceof Element){d.appendChild(g)}else{d.appendChild(L.XmlUtil.createTextNode(g||""))}f.appendChild(d);return f}});L.WFST.include({insert:function(d){var e=L.XmlUtil.createElementNS("wfs:Insert");e.appendChild(this.gmlFeature(d));return e},update:function(f){var h=L.XmlUtil.createElementNS("wfs:Update",{typeName:this.options.typeNSName});var e=f.feature;for(var d in e.properties){h.appendChild(this.wfsProperty(d,e.properties[d]))}h.appendChild(this.wfsProperty(this.namespaceName(this.options.geometryField),f.toGml(this.options.crs)));var g=new L.Filter.GmlObjectID().append(f.feature.id);h.appendChild(g.toGml());return h},remove:function(d){var f=L.XmlUtil.createElementNS("wfs:Delete",{typeName:this.options.typeNSName});var e=new L.Filter.GmlObjectID().append(d.feature.id);f.appendChild(e.toGml());return f}})})(window,document);